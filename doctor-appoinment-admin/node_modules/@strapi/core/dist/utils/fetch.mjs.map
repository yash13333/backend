{"version":3,"file":"fetch.mjs","sources":["../../src/utils/fetch.ts"],"sourcesContent":["import type { Core, Modules } from '@strapi/types';\nimport { ProxyAgent } from 'undici';\n\n// TODO: once core Node exposes a stable way to create a ProxyAgent we will use that instead of undici\n\n// Create a wrapper for Node's Fetch API that applies a global proxy\nexport const createStrapiFetch = (strapi: Core.Strapi): Modules.Fetch.Fetch => {\n  function strapiFetch(url: RequestInfo | URL, options?: RequestInit) {\n    const fetchOptions = {\n      ...(strapiFetch.dispatcher ? { dispatcher: strapiFetch.dispatcher } : {}),\n      ...options,\n    };\n    strapi.log.debug(`Making request for ${url}`);\n    return fetch(url, fetchOptions);\n  }\n\n  const proxy =\n    strapi.config.get<ConstructorParameters<typeof ProxyAgent>[0]>('server.proxy.fetch') ||\n    strapi.config.get<string>('server.proxy.global');\n\n  if (proxy) {\n    strapi.log.info(`Using proxy for Fetch requests: ${proxy}`);\n    strapiFetch.dispatcher = new ProxyAgent(proxy);\n  }\n\n  return strapiFetch;\n};\n\nexport type Fetch = Modules.Fetch.Fetch;\n"],"names":["createStrapiFetch","strapi","strapiFetch","url","options","fetchOptions","dispatcher","log","debug","fetch","proxy","config","get","info","ProxyAgent"],"mappings":";;AAGA;AAEA;AACO,MAAMA,oBAAoB,CAACC,MAAAA,GAAAA;IAChC,SAASC,WAAAA,CAAYC,GAAsB,EAAEC,OAAqB,EAAA;AAChE,QAAA,MAAMC,YAAe,GAAA;YACnB,GAAIH,WAAAA,CAAYI,UAAU,GAAG;AAAEA,gBAAAA,UAAAA,EAAYJ,YAAYI;AAAW,aAAA,GAAI,EAAE;AACxE,YAAA,GAAGF;AACL,SAAA;QACAH,MAAOM,CAAAA,GAAG,CAACC,KAAK,CAAC,CAAC,mBAAmB,EAAEL,IAAI,CAAC,CAAA;AAC5C,QAAA,OAAOM,MAAMN,GAAKE,EAAAA,YAAAA,CAAAA;AACpB;IAEA,MAAMK,KAAAA,GACJT,MAAOU,CAAAA,MAAM,CAACC,GAAG,CAA8C,oBAAA,CAAA,IAC/DX,MAAOU,CAAAA,MAAM,CAACC,GAAG,CAAS,qBAAA,CAAA;AAE5B,IAAA,IAAIF,KAAO,EAAA;QACTT,MAAOM,CAAAA,GAAG,CAACM,IAAI,CAAC,CAAC,gCAAgC,EAAEH,MAAM,CAAC,CAAA;QAC1DR,WAAYI,CAAAA,UAAU,GAAG,IAAIQ,UAAWJ,CAAAA,KAAAA,CAAAA;AAC1C;IAEA,OAAOR,WAAAA;AACT;;;;"}