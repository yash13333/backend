{"version":3,"file":"serverRestartWatcher.js","sources":["../../../../../admin/src/components/DataManagerProvider/utils/serverRestartWatcher.ts"],"sourcesContent":["const SERVER_HAS_NOT_BEEN_KILLED_MESSAGE = 'did-not-kill-server';\nconst SERVER_HAS_BEEN_KILLED_MESSAGE = 'server is down';\n\n/**\n * Server restart watcher\n * Sends an HEAD method to check if the server has been shut down correctly\n * and then pings until it's back on\n */\nexport function serverRestartWatcher(response: any, didShutDownServer?: boolean) {\n  return new Promise((resolve) => {\n    // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n    // @ts-ignore\n    fetch(`${window.strapi.backendURL}/_health`, {\n      method: 'HEAD',\n      mode: 'no-cors',\n      headers: {\n        'Content-Type': 'application/json',\n        'Keep-Alive': 'false',\n      },\n    })\n      .then((res) => {\n        if (res.status >= 400) {\n          throw new Error(SERVER_HAS_BEEN_KILLED_MESSAGE);\n        }\n\n        if (!didShutDownServer) {\n          throw new Error(SERVER_HAS_NOT_BEEN_KILLED_MESSAGE);\n        }\n\n        resolve(response);\n      })\n      .catch((err) => {\n        setTimeout(() => {\n          return serverRestartWatcher(\n            response,\n            err.message !== SERVER_HAS_NOT_BEEN_KILLED_MESSAGE\n          ).then(resolve);\n        }, 100);\n      });\n  });\n}\n"],"names":["SERVER_HAS_NOT_BEEN_KILLED_MESSAGE","SERVER_HAS_BEEN_KILLED_MESSAGE","serverRestartWatcher","response","didShutDownServer","Promise","resolve","fetch","window","strapi","backendURL","method","mode","headers","then","res","status","Error","catch","err","setTimeout","message"],"mappings":";;AAAA,MAAMA,kCAAqC,GAAA,qBAAA;AAC3C,MAAMC,8BAAiC,GAAA,gBAAA;AAEvC;;;;AAIC,IACM,SAASC,oBAAqBC,CAAAA,QAAa,EAAEC,iBAA2B,EAAA;IAC7E,OAAO,IAAIC,QAAQ,CAACC,OAAAA,GAAAA;;;QAGlBC,KAAM,CAAA,CAAC,EAAEC,MAAOC,CAAAA,MAAM,CAACC,UAAU,CAAC,QAAQ,CAAC,EAAE;YAC3CC,MAAQ,EAAA,MAAA;YACRC,IAAM,EAAA,SAAA;YACNC,OAAS,EAAA;gBACP,cAAgB,EAAA,kBAAA;gBAChB,YAAc,EAAA;AAChB;SAECC,CAAAA,CAAAA,IAAI,CAAC,CAACC,GAAAA,GAAAA;YACL,IAAIA,GAAAA,CAAIC,MAAM,IAAI,GAAK,EAAA;AACrB,gBAAA,MAAM,IAAIC,KAAMhB,CAAAA,8BAAAA,CAAAA;AAClB;AAEA,YAAA,IAAI,CAACG,iBAAmB,EAAA;AACtB,gBAAA,MAAM,IAAIa,KAAMjB,CAAAA,kCAAAA,CAAAA;AAClB;YAEAM,OAAQH,CAAAA,QAAAA,CAAAA;SAETe,CAAAA,CAAAA,KAAK,CAAC,CAACC,GAAAA,GAAAA;YACNC,UAAW,CAAA,IAAA;AACT,gBAAA,OAAOlB,qBACLC,QACAgB,EAAAA,GAAAA,CAAIE,OAAO,KAAKrB,kCAAAA,CAAAA,CAChBc,IAAI,CAACR,OAAAA,CAAAA;aACN,EAAA,GAAA,CAAA;AACL,SAAA,CAAA;AACJ,KAAA,CAAA;AACF;;;;"}