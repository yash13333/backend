{"version":3,"file":"disable.mjs","sources":["../../../../../src/cli/commands/telemetry/disable.ts"],"sourcesContent":["import { resolve } from 'path';\nimport fse from 'fs-extra';\nimport chalk from 'chalk';\nimport { createCommand } from 'commander';\n\nimport type { StrapiCommand } from '../../types';\nimport { runAction } from '../../utils/helpers';\nimport { sendEvent } from '../../utils/telemetry';\n\nconst readPackageJSON = async (path: string) => {\n  try {\n    const packageObj = await fse.readJson(path);\n    const uuid = packageObj.strapi ? packageObj.strapi.uuid : null;\n\n    return { uuid, packageObj };\n  } catch (err) {\n    if (err instanceof Error) {\n      console.error(`${chalk.red('Error')}: ${err.message}`);\n    }\n  }\n};\n\nconst writePackageJSON = async (path: string, file: object, spacing: number) => {\n  try {\n    await fse.writeJson(path, file, { spaces: spacing });\n    return true;\n  } catch (err) {\n    if (err instanceof Error) {\n      console.error(`${chalk.red('Error')}: ${err.message}`);\n    }\n  }\n};\n\nconst action = async () => {\n  const packageJSONPath = resolve(process.cwd(), 'package.json');\n  const exists = await fse.pathExists(packageJSONPath);\n\n  if (!exists) {\n    console.log(`${chalk.yellow('Warning')}: could not find package.json`);\n    process.exit(0);\n  }\n\n  const { uuid, packageObj } = (await readPackageJSON(packageJSONPath)) ?? {};\n\n  if ((packageObj.strapi && packageObj.strapi.telemetryDisabled) || !uuid) {\n    console.log(`${chalk.yellow('Warning:')} telemetry is already disabled`);\n    process.exit(0);\n  }\n\n  const updatedPackageJSON = {\n    ...packageObj,\n    strapi: {\n      ...packageObj.strapi,\n      telemetryDisabled: true,\n    },\n  };\n\n  const write = await writePackageJSON(packageJSONPath, updatedPackageJSON, 2);\n\n  if (!write) {\n    console.log(\n      `${chalk.yellow(\n        'Warning'\n      )}: There has been an error, please set \"telemetryDisabled\": true in the \"strapi\" object of your package.json manually.`\n    );\n    process.exit(0);\n  }\n\n  await sendEvent('didOptOutTelemetry', uuid);\n  console.log(`${chalk.green('Successfully opted out of Strapi telemetry')}`);\n  process.exit(0);\n};\n\n/**\n * `$ strapi telemetry:disable`\n */\nconst command: StrapiCommand = () => {\n  return createCommand('telemetry:disable')\n    .description('Disable anonymous telemetry and metadata sending to Strapi analytics')\n    .action(runAction('telemetry:disable', action));\n};\n\nexport { action, command };\n"],"names":["readPackageJSON","path","packageObj","fse","readJson","uuid","strapi","err","Error","console","error","chalk","red","message","writePackageJSON","file","spacing","writeJson","spaces","action","packageJSONPath","resolve","process","cwd","exists","pathExists","log","yellow","exit","telemetryDisabled","updatedPackageJSON","write","sendEvent","green","command","createCommand","description","runAction"],"mappings":"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"}